# Command Router

A command processor receives a command, parses that, looks up the command handler for the command, and writes events on success. A command processor can be easily integrated within a server. We can easily use HTTP, gRPC, message queues, or whatever protocol that suits well with the environment.

What we need to care about in the execution of command handlers are concurrent updates to the same summary and side effects.

## Concurrent Updates

As written in [#event-insertion](../rethink-event-sourcing.md#event-insertion "mention"), concurrent updates to the same summary can be prevented by using an optimistic or pessimistic lock. It can be also controlled by queuing up commands to each summary. To do that, commands to the same summary need to be routed to a specific process. This can be supported by a sticky routing. There are many ways to do that such as using a network router, network calls, or message queue.

## Side Effects

Though an optimistic lock can prevent concurrent updates, it does not prevent concurrent invocation of command handlers. Though events generated by them won't be stored, side effects in the command handlers cannot be canceled. This could lead to complex problems.

We can prevent this by blocking execution of command handlers to a specific summary. The easiest way is to use a pessimistic lock. We can also support that on the command router layer.

By using a sticky command router, commands to the same summary can be routed to the same process. Commands can be queued up for each summary. By doing this, we can block some processes.

There is another benefit on summary caching. By using a sticky router, the cache hit ratio would go up significantly, which also reduces the size of caches in the processes.

Note that by using a pessimistic lock, both concurrent updates and side effects can be prevented by blocking command handlers. The use of a sticky router is just for performance optimization. It would not be worth having a complex routing mechanism such as distributed coordination just for performance.
